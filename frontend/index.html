<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Convertidor P2P</title>
    <link rel="icon" href="/frontend/public/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/frontend/styles/base.css">
    <link rel="stylesheet" href="/frontend/styles/layout.css">
    <link rel="stylesheet" href="/frontend/styles/components.css">
    <link rel="stylesheet" href="/frontend/styles/themes.css">
    <link rel="stylesheet" href="/frontend/styles/panel.css">
    <link rel="stylesheet" href="/frontend/styles/custom-select.css">
    <link rel="stylesheet" href="/frontend/styles/responsive.css">
</head>
<body>
    <!-- Botón flotante del panel -->
    <button 
        id="panel-toggle-btn" 
        class="panel-toggle-btn floating" 
        title="Ver información y configuración"
        aria-label="Abrir panel de información"
        aria-expanded="false"
        type="button"
    >
        <img src="/frontend/public/ajustes.svg" alt="Ajustes" class="panel-icon" aria-hidden="true" draggable="false" oncontextmenu="return false;" ondragstart="return false;" style="pointer-events: none; user-select: none;">
    </button>

    <div class="container">
        <div class="converter-card">
            <!-- Header con monedas -->
            <div class="card-header">
                <div class="currency-selectors-container">
                    <!-- Moneda Origen -->
                    <div class="currency-selector-wrapper">
                        <div class="currency-selector-box">
                            <select id="fiatFrom" class="currency-select">
                                <option value="ARS" selected data-abbr="ARS">ARS - Peso Argentino</option>
                                <option value="BOB" data-abbr="BOB">BOB - Boliviano</option>
                                <option value="CLP" data-abbr="CLP">CLP - Peso Chileno</option>
                                <option value="MXN" data-abbr="MXN">MXN - Peso Mexicano</option>
                                <option value="PEN" data-abbr="PEN">PEN - Sol Peruano</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Botón de Intercambio -->
                    <button id="swap-currencies-btn" class="swap-btn" title="Intercambiar monedas" aria-label="Intercambiar monedas">
                        <img src="/frontend/public/intercambio.svg" alt="Intercambiar" class="swap-icon">
                    </button>
                    
                    <!-- Moneda Destino -->
                    <div class="currency-selector-wrapper">
                        <div class="currency-selector-box">
                            <select id="fiatTo" class="currency-select">
                                <option value="ARS" data-abbr="ARS">ARS - Peso Argentino</option>
                                <option value="BOB" selected data-abbr="BOB">BOB - Boliviano</option>
                                <option value="CLP" data-abbr="CLP">CLP - Peso Chileno</option>
                                <option value="MXN" data-abbr="MXN">MXN - Peso Mexicano</option>
                                <option value="PEN" data-abbr="PEN">PEN - Sol Peruano</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input principal -->
            <div class="input-section">
                <label for="amount" class="input-label">Monto a convertir</label>
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="amount" 
                        class="main-input" 
                        placeholder="0,00" 
                        autocomplete="off"
                        inputmode="decimal"
                    >
                    <span class="input-currency" id="input-currency">ARS</span>
                </div>
            </div>


            <!-- Resultado -->
            <div id="result" class="result-section" style="display: none;"></div>
            <div id="error" class="error-section" style="display: none;"></div>

            <!-- Botón actualizar y microcopy -->
            <div class="card-footer">
                <button id="refresh-btn" class="refresh-btn-premium">
                    <svg class="refresh-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Actualizar precios</span>
                </button>
                <p class="microcopy">Precios basados en Binance P2P</p>
            </div>
        </div>
    </div>

    <!-- Panel de Información (oculto por defecto) -->
    <div id="info-panel" class="info-panel" style="display: none;">
        <div class="info-panel-overlay" id="panel-overlay"></div>
        <div class="info-panel-content">
            <div class="info-panel-header">
                <h2>Panel de Información</h2>
                <button id="panel-close-btn" class="panel-close-btn" title="Cerrar">✕</button>
            </div>

            <div class="info-panel-body" id="panel-body">
                <!-- El contenido se carga dinámicamente desde frontend/htmls/panel.html -->
            </div>
        </div>
    </div>
    
    <script>
        // Cargar configuraciones públicas antes de inicializar
        (async function() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    // Exponer variables en window para que el calculador las pueda leer
                    window.NEXT_PUBLIC_SUPABASE_URL = config.NEXT_PUBLIC_SUPABASE_URL || config.VITE_SUPABASE_URL;
                    window.NEXT_PUBLIC_SUPABASE_ANON_KEY = config.NEXT_PUBLIC_SUPABASE_ANON_KEY || config.VITE_SUPABASE_ANON_KEY;
                }
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
            // Inicializar la aplicación después de cargar las variables
            // Esperar un momento para asegurar que el DOM esté listo
            setTimeout(() => {
                const script = document.createElement('script');
                script.type = 'module';
                script.src = '/frontend/index.js';
                script.onerror = function() {
                    console.error('Error cargando /frontend/index.js');
                };
                document.body.appendChild(script);
            }, 100);
        })();

        // Sistema de Panel y Temas
        (function() {
            // Panel toggle
            const panelToggle = document.getElementById('panel-toggle-btn');
            const panel = document.getElementById('info-panel');
            const panelClose = document.getElementById('panel-close-btn');
            const panelOverlay = document.getElementById('panel-overlay');

            function openPanel() {
                panel.style.display = 'block';
                if (panelToggle) {
                    panelToggle.setAttribute('aria-expanded', 'true');
                }
                setTimeout(() => {
                    panel.classList.add('active');
                }, 10);
                document.body.style.overflow = 'hidden';
            }

            function closePanel() {
                panel.classList.remove('active');
                if (panelToggle) {
                    panelToggle.setAttribute('aria-expanded', 'false');
                }
                setTimeout(() => {
                    panel.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }

            // Event listeners del panel
            if (panelToggle) {
                panelToggle.addEventListener('click', () => {
                    const isOpen = panel.classList.contains('active') || panel.style.display === 'block';
                    if (isOpen) {
                        closePanel();
                    } else {
                        openPanel();
                        // Cargar contenido solo la primera vez
                        if (!panel.classList.contains('loaded')) {
                            loadPanelContent();
                            panel.classList.add('loaded');
                        }
                    }
                });
            }
            if (panelClose) {
                panelClose.addEventListener('click', closePanel);
            }
            if (panelOverlay) {
                panelOverlay.addEventListener('click', closePanel);
            }

            // Inicializar sistema de temas desde módulo compartido
            const themeModule = await import('/frontend/ui/theme.js');
            const { applyTheme, initThemeSystem } = themeModule;

            // Aplicar tema inicial si existe
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);


            // Cargar contenido del panel desde HTML
            async function loadPanelContent() {
                const panelBody = document.getElementById('panel-body');
                if (!panelBody) return;

                try {
                    // Cargar el HTML del panel
                    const response = await fetch('/frontend/htmls/panel.html');
                    if (!response.ok) throw new Error('No se pudo cargar el panel');
                    
                    const html = await response.text();
                    panelBody.innerHTML = html;

                    // Inicializar sistema de temas después de cargar el HTML
                    initThemeSystem();

                    // Inicializar botones del panel y popups
                    const { initPanelButtons } = await import('/frontend/ui/panel-popups.js');
                    initPanelButtons();
                } catch (error) {
                    console.error('Error cargando panel:', error);
                    panelBody.innerHTML = '<div class="error-text">Error al cargar el panel</div>';
                }
            }


            // Cargar precios en el panel
            async function loadPanelPrices() {
                const tbody = document.getElementById('prices-tbody');
                if (!tbody) return;

                try {
                    const { getPrices } = await import('/calculator/index.js');
                    const prices = await getPrices();
                    
                    if (!prices || Object.keys(prices).length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="empty-text">No hay precios disponibles</td></tr>';
                        return;
                    }

                    const fiats = Object.keys(prices).sort();
                    tbody.innerHTML = fiats.map(fiat => {
                        const buy = prices[fiat]?.buy || 'N/A';
                        const sell = prices[fiat]?.sell || 'N/A';
                        const buyFormatted = typeof buy === 'number' ? buy.toFixed(2) : buy;
                        const sellFormatted = typeof sell === 'number' ? sell.toFixed(2) : sell;
                        
                        return `
                            <tr>
                                <td><strong>${fiat}</strong></td>
                                <td>${buyFormatted}</td>
                                <td>${sellFormatted}</td>
                                <td>Reciente</td>
                            </tr>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error cargando precios:', error);
                    tbody.innerHTML = '<tr><td colspan="4" class="error-text">Error al cargar precios</td></tr>';
                }
            }

        })();
    </script>
</body>
</html>
